<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
   "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
<head>
    <title>Restia</title>
    <link rel="stylesheet" href="../ldoc.css" type="text/css" />
</head>
<body>

<div id="container">

<div id="product">
	<div id="product_logo"></div>
	<div id="product_name"><big><b></b></big></div>
	<div id="product_description"></div>
</div> <!-- id="product" -->


<div id="main">


<!-- Menu -->

<div id="navigation">
<br/>
<h1>Restia</h1>

<ul>
  <li><a href="../index.html">Index</a></li>
</ul>

<h2>Contents</h2>
<ul>
<li><a href="#Single_Function_Request_Handlers">Single-Function Request Handlers </a></li>
<li><a href="#Multi_Action_Controllers">Multi-Action Controllers </a></li>
<li><a href="#Stateful_Controllers">Stateful Controllers </a></li>
</ul>


<h2>Topics</h2>
<ul class="">
  <li><a href="../topics/readme.md.html">readme</a></li>
  <li><a href="../topics/license.md.html">license</a></li>
  <li><a href="../topics/getting-started.md.html">getting-started</a></li>
  <li><strong>controllers</strong></li>
</ul>
<h2>Modules</h2>
<ul class="nowrap">
  <li><a href="../modules/restia.attributes.html">restia.attributes</a></li>
  <li><a href="../modules/restia.commands.html">restia.commands</a></li>
  <li><a href="../modules/restia.bin.manpage.html">restia.bin.manpage</a></li>
  <li><a href="../modules/restia.config.html">restia.config</a></li>
  <li><a href="../modules/restia.handler.html">restia.handler</a></li>
  <li><a href="../modules/restia.logbuffer.html">restia.logbuffer</a></li>
  <li><a href="../modules/restia.markdown.html">restia.markdown</a></li>
  <li><a href="../modules/restia.negotiator.html">restia.negotiator</a></li>
  <li><a href="../modules/restia.request.html">restia.request</a></li>
  <li><a href="../modules/restia.secret.html">restia.secret</a></li>
  <li><a href="../modules/restia.template.html">restia.template</a></li>
  <li><a href="../modules/restia.utils.html">restia.utils</a></li>
</ul>
<h2>Scripts</h2>
<ul class="nowrap">
  <li><a href="../scripts/restia.html">restia</a></li>
</ul>

</div>

<div id="content">

    <h1>Using Controllers (or Handlers)</h1>

<p>Restia does not assume a MVC-workflow, but supports it when needed. As such, it
does not have a specific concept for controllers, but allows grouping request
handlers into modules.</p>

<p><a name="Single_Function_Request_Handlers"></a></p>

<h2>Single-Function Request Handlers</h2>

<p>A controller module can return a single function that will handle a specific
request, usually mapped to a single route. This is often enough for simple cases
and special pages that don&rsquo;t fit neatly into an MVC design, like landing pages,
legal notices, etc.</p>

<p>When <a href="../modules/restia.handler.html#serve">restia.handler.serve</a> is called without an action argument, it will
default to this behaviour.</p>

<p>A typical location could look like this:</p>

<pre>
<span class="comment">-- locations/landing
</span>location = / {
    content_by_lua_block {
        restia.handler.serve(<span class="string">"controllers.landing"</span>, <span class="string">"error"</span>)
    }
}
</pre>


<p>with a corresponding controller module:</p>

<pre>
<span class="comment">-- controllers/landing.lua
</span><span class="keyword">return</span> <span class="keyword">function</span>(req)
    <span class="keyword">return</span> ngx.say(<span class="string">"Welcome to my website!"</span>)
<span class="keyword">end</span>
</pre>


<p><a name="Multi_Action_Controllers"></a></p>

<h2>Multi-Action Controllers</h2>

<p>A controller module may also return a table containing several actions. To pick
what action to call, an additional string argument must be passed to the
<a href="../modules/restia.handler.html#serve">restia.handler.serve</a> function, which describes the table path to the
request handler.</p>

<p>Note that nested tables are possible, as <a href="../modules/restia.utils.html#deepindex">restia.utils.deepindex</a> is used to
interpret this action path.</p>

<p>This will, in most cases, be set up in the location block, which might look as
follows:</p>

<pre>
<span class="comment">-- locations/user
</span>location = /user {
    content_by_lua_block {
        restia.handler.serve(<span class="string">"controllers.landing"</span>, <span class="string">"error"</span>, <span class="string">"list"</span>)
    }
}
location ~ ^/user/(\d+)/(profile|posts)$ {
    content_by_lua_block {
        restia.handler.serve(<span class="string">"controllers.landing"</span>, <span class="string">"error"</span>, ngx.var[<span class="number">2</span>], ngx.var[<span class="number">1</span>])
    }
}
</pre>


<p>And the controller module might look somewhat like this:</p>

<pre>
<span class="comment">-- controllers/user.lua
</span><span class="keyword">local</span> user = {}

<span class="keyword">function</span> user.list(req)
    <span class="comment">-- List all users
</span><span class="keyword">end</span>

<span class="keyword">function</span> user.profile(req, id)
    <span class="comment">-- Render a users profile
</span><span class="keyword">end</span>

<span class="comment">-- ...</span>
</pre>


<p>Note that the <code>ngx.var[1]</code> gets passed through to the event handler after the
request object. While the request handler could get this data itself through the
<code>ngx</code> module, this way makes its interface more explicit and reusable.</p>

<p><a name="Stateful_Controllers"></a></p>

<h2>Stateful Controllers</h2>

<p>Unlike in frameworks like Rails, controllers aren&rsquo;t object instances and don&rsquo;t
store any state. This is intentional and should encourage passing state around
explicitly. If stateful controller instances are desired, these must be manually
implemented.</p>

<p>To achieve this, one has to build their own wrapper around
<code>restia.controller.xpcall</code> that creates an instance before calling a method on
it.</p>


</div> <!-- id="content" -->
</div> <!-- id="main" -->
<div id="about">
<i>generated by <a href="http://github.com/stevedonovan/LDoc">LDoc 1.4.6</a></i>
<i style="float:right;">Last updated 2021-01-03 16:45:09 </i>
</div> <!-- id="about" -->
</div> <!-- id="container" -->
</body>
</html>
